<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>微风科技后台管理系统</title>
    <link rel="icon"href="../images/logo.jpg"type="image/x-icon"/>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <link rel="stylesheet" type="text/css" href="../css/nav.css">
    <link href="../css/system.css"rel="stylesheet"/>
    <link rel="stylesheet" href="../LayUI/css/layui.css" media="all">
    <link rel="stylesheet" href="../css/change.css" />
</head>
<body>
<div class="system_header">
    <strong>WindTech</strong>
    <strong>退出</strong>
</div>
<div class="nav">
    <ul>
        <li class="nav-item nav-head">
            <a href="javascript:;"><img src="../images/home.png"class="menu_logo"/><span>主页</span></a>
        </li>
        <li class="nav-item">
            <a href="javascript:;"><img src="../images/shop.png"class="menu_logo"/><span>商品管理</span>
                <i class="my-icon nav-more"><img src="../images/arrow_right.png"style="width: 1.5vw;height: 1.5vw;"/></i></a>
            <ul>
                <li class="tab-click"id="object1"onclick="javaScript:tabclick(this)"data-type="tabAdd"><a><span>库存</span></a></li>
                <li class="tab-click"id="object2"onclick="javaScript:tabclick(this)"data-type="tabAdd"><a><span>商品导入</span></a></li>
            </ul>
        </li>
        <li class="nav-item">
            <a href="javascript:;"><img src="../images/sale.png"class="menu_logo"/><span>销售管理</span>
                <i class="my-icon nav-more"><img src="../images/arrow_right.png"style="width: 1.5vw;height: 1.5vw;"/></i></a>
            <ul>
                <li class="tab-click"id="object3"onclick="javaScript:tabclick(this)"data-type="tabAdd"><a><span>营销情况</span></a></li>
                <li class="tab-click"id="object4"onclick="javaScript:tabclick(this)"data-type="tabAdd"><a><span>盈利情况</span></a></li>
            </ul>
        </li>
        <li class="nav-item tab-click"id="object5"onclick="javaScript:tabclick(this)"data-type="tabAdd">
            <a href="javascript:;"><span>发布活动</span></a>
        </li>
    </ul>
</div>

<div class="layui-tab" lay-filter="demo" lay-allowclose="true">
    <ul class="layui-tab-title">
        <li class="layui-this" lay-id="11">主页</li>
    </ul>
    <div class="layui-tab-content">
        <div class="layui-tab-item layui-show">这里是主页</div>
        <!--<div class="layui-tab-item">这里是库存</div>-->
    </div>
</div>
<form id="form-addpro" role="form">
<div class="add_product"style="display: none;"id="add_Brand">
        名称：<input type="text" class="add_name" placeholder="请输入产品名称"id="product_name"name="pro_Name"/>
        系列：<input type="text" class="add_name" placeholder="请输入产品系列"id="product_own"name="pro_Type"/><br/>
        库存数量：<input type="text" class="add_name" placeholder="请输入库存"id="product_num"name="pro_Num"/>
        状态：<select id="product_select"name="pro_State"><option value="1">售卖中</option>
            <option value="0">未上线</option></select><br/>
        图片：<input class="add_img"id="product_img"type="file"name="pro_img"/><br />
        产品描述：<br/><textarea cols="20"class="add_info"name="pro_info"id="product_info"form="form-addpro"></textarea>
</div>
</form>
<div class="system_bottom">© WindTechInventory.com - 后台管理系统</div>
<script src="../js/jquery-1.9.1.min.js"></script>
<script src="../js/nav.js"></script>
<script src="../LayUI/layui.js" charset="utf-8"></script>
<script type="text/javascript" src="../js/Change.js" ></script>
<script>
    var tabclick,pro_id;
    //左侧点击选择页面
    layui.use('element', function(){
        var $ = layui.jquery,element = layui.element;
        var oUl=$(".layui-tab-title");
        tabclick=function(e){
            var olis=oUl.children();
            for(var i=0;i<olis.length;i++){
                if(olis.eq(i).attr('lay-id')==e.id){
                    element.tabChange('demo',e.id);
                    return false;
                }
            }
            element.tabAdd('demo', {title: e.innerText,
                content:'<div id="add_'+e.id+'"class="scroll"></div>',
                id: e.id});
            element.tabChange('demo',e.id);
            $(function(){choose(e.id);})
        }
    });
    //选择显示不同的页面
    function choose(id){
        //库存页
        if(id=='object1'){
            $("#add_"+id).append(append_kuncun);
            //从数据库中拿数据进行产品显示
            showProList();
        }
        if(id=='object2'){
            $("#add_"+id).append('<button>qsi</button>');
        }
    }
    var form,layer;
    layui.use(['table','layer','form'], function(){
        var table = layui.table;
        form= layui.form;
        layer=layui.layer;
    });
    //从数据库中拿出产品数据
    function showProList(){
        var index = layer.load(1, {
            shade: [0.1,'#fff'] ,time:400
        });
        $.ajax({
            "url":"/products/show",
            "type":"GET",
            "dataType":"json",
            "success":function(json) {
                if (json.state == 200) {
                    $("#table_body").empty();
                    var list = json.data;
                    var state;
                    for (var i = 0; i < list.length; i++) {
                        var html = '<tr id="tr#{pid}">'
                            +'<td>#{pid}</td>'
                            +'<td>#{pro_Name}</td>'
                            +'<td>#{pro_own}</td>'
                            +'<td>#{pro_img}</td>'
                            +'<td>#{pro_num}</td>'
                            +'<td>#{state}</td>'
                            +'<td><button class="table_btn"onclick="change_pro(\'tr#{pid}\',\'#{pid}\')">修改</button> '
                            +'<button class="table_btn btn_del" onclick="del_pro(\'tr#{pid}\',\'#{pid}\')">删除</button></td>'
                            +'</tr>'
                        html = html.replace(/#{pid}/g, list[i].pid);
                        html = html.replace(/#{pro_Name}/g, list[i].pro_Name);
                        html = html.replace(/#{pro_own}/g, list[i].pro_Type);
                        html = html.replace(/#{pro_img}/g, list[i].pro_img);
                        html = html.replace(/#{pro_num}/g, list[i].pro_Num);
                        if(list[i].pro_State==0){
                            html = html.replace(/#{state}/g, '<button class="table_btn btn_nosale">未上线</button>');
                        }else{
                            html = html.replace(/#{state}/g, '<button class="table_btn btn_sale">售卖中</button>');
                        }
                        $("#table_body").append(html);
                    }
                    if(list.length == 0){
                        pro_id=1;
                    }else{
                        pro_id=list[list.length-1].pid+1;
                    }
                } else {
                    alert(json.message);
                }
            }
        });
    }
    //添加产品
    function cell_add(){
        console.log(pro_id);
        var tr_id='tr'+pro_id;
        layer.open({
            id:1,
            type: 1,
            title:'添加产品',
            skin:'layui-layer-rim',
            area:['38vw', 'auto'],
            content: $('#add_Brand'),
            btn:['保存','取消'],
            yes: function (index,layero) {
                var table_sel;
                var name=$("#product_name").val();
                var own=$("#product_own").val();
                var num=$("#product_num").val();
                var info=$("#product_info").val();
                var pro_select = $("#product_select option:selected");
                if(pro_select.text()=="未上线"){
                    table_sel='<button class="table_btn btn_nosale">未上线</button>'
                }else{
                    table_sel='<button class="table_btn btn_sale">售卖中</button>'
                }
                //添加到数据库
                $.ajax({
                    "url":"/products/add",
                    "data":$("#form-addpro").serialize(),
                    "type":"POST",
                    "data":{
                        pro_Name : name,
                        pro_Type : own,
                        pro_Num : num,
                        pro_State : pro_select.val(),
                        pro_img:"图片",
                        pro_info:info
                    },
                    "dataType":"json",
                    "success":function(json) {
                        //添加到数据库成功
                        if (json.state == 200) {
                            //添加到页面成功
                            $("#table_body").append(
                                '<tr id='+tr_id+'>'
                                +'<td>'+pro_id+'</td>'
                                +'<td>'+name+'</td>'
                                +'<td>'+own+'</td>'
                                +'<td>图片</td>'
                                +'<td>'+num+'</td>'
                                +'<td>'+table_sel+'</td>'
                                +'<td><button class="table_btn"onclick="change_pro(\''+tr_id+'\',\''+pro_id+'\')">修改</button> '
                                +'<button class="table_btn btn_del" onclick="del_pro(\''+tr_id+'\',\''+pro_id+'\')">删除</button></td>'
                                +'</tr>')
                            pro_id+=1;
                            layer.msg('添加成功', {icon: 1,time:1500});
                        } else {
                            alert(json.message);
                        }
                    },
                    "error":function() {
                        layer.msg('添加失败！请重新尝试', {icon: 2,time:1500});
                    }
                });
                //清空页面数据
                clear();
                layer.close(index);
            },
            end:function (index,layero) {
                layer.close(index);
            }
        });
    }
    function clear(){
        $("#product_name").val('');
        $("#product_own").val('');
        $("#product_num").val('');
        $("#product_info").val('');
    }
    //删除特定的产品
    function del_pro(id,pid){
        layer.confirm('请问您确定要删除该产品吗？', {
            btn: ['确定','取消'] //按钮
        }, function(){
            var tr=document.getElementById(id);
            $.ajax({
                "url":"/products/" + pid + "/delete",
                "type":"POST",
                "dataType":"json",
                "success":function(json) {
                    //删除数据库数据成功
                    if (json.state == 200) {
                        layer.msg('删除成功', {icon: 1,time:1500});
                        //删除页面数据
                        tr.parentNode.removeChild(tr);
                    } else {
                        alert(json.message);
                    }
                },
                "error":function() {
                    layer.msg('删除失败！请重新尝试', {icon: 2,time:1500});
                }
            });
        }, function(){});
    }
    function change_pro(id,pid){
        $.ajax({
            "async" : false,
            "url":"/products/" + pid + "/showPro",
            "type":"GET",
            "dataType":"json",
            "success":function(json) {
                //拿取数据成功
                var tdinfo=json.data;
                if (json.state == 200) {
                    $("#product_name").val(tdinfo.pro_Name);
                    $("#product_own").val(tdinfo.pro_Type);
                    $("#product_num").val(tdinfo.pro_Num);
                    $("#product_info").val(tdinfo.pro_info);
                    if(tdinfo.pro_State==0){
                        $("#product_select").val('0');
                    }
                    layer.open({
                        id:1,
                        type: 1,
                        title:'修改产品',
                        skin:'layui-layer-rim',
                        area:['38vw', 'auto'],
                        content: $('#add_Brand'),
                        btn:['保存','取消'],
                        yes: function (index,layero) {
                            $.ajax({
                                "async" : false,
                                "url":"/products/" + pid + "/change_info",
                                "type":"POST",
                                "dataType":"json",
                                "data":$("#form-addpro").serialize(),
                                "success":function(json) {
                                    if(json.state ==200){
                                        showProList();
                                        clear();
                                        layer.msg('更新数据成功', {icon: 1,time:1500});
                                    }else{
                                        alert(json.message);
                                    }
                                },
                                "error":function() {
                                    layer.msg('更新数据失败！请重新尝试', {icon: 2,time:1500});
                                }
                            });
                            layer.close(index);
                        },
                        end:function(index,layero){
                            layer.close(index);
                        }
                    });
                } else {
                    alert(json.message);
                }
            },
            "error":function() {
                layer.msg('获取数据失败！请重新尝试', {icon: 2,time:1500});
            }
        });
    }
</script>
</body>
</html>
